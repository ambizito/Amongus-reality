<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Task Eletrica Ritmo</title>
    <link rel="stylesheet" href="/tasks/shared.css" />
    <style>
      .meter {
        margin-top: 16px;
        width: 100%;
        height: 26px;
        border-radius: 999px;
        border: 1px solid #334155;
        background: #0b1220;
        position: relative;
        overflow: hidden;
      }
      .target {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 60px;
        background: rgba(34, 197, 94, 0.35);
        border-left: 2px solid rgba(34, 197, 94, 0.7);
        border-right: 2px solid rgba(34, 197, 94, 0.7);
      }
      .needle {
        position: absolute;
        top: -6px;
        width: 16px;
        height: 38px;
        border-radius: 8px;
        background: #f59e0b;
        box-shadow: 0 0 12px rgba(245, 158, 11, 0.6);
      }
      .task-button {
        margin-top: 16px;
        width: 100%;
        padding: 12px 16px;
        border-radius: 12px;
        border: 0;
        background: #f8fafc;
        color: #0f172a;
        font-weight: 800;
        cursor: pointer;
      }
      .hud {
        margin-top: 10px;
        font-size: 12px;
        color: var(--muted);
        display: flex;
        justify-content: space-between;
      }
      .status.success {
        color: #22c55e;
        font-weight: 700;
      }
    </style>
  </head>
  <body>
    <div class="task">
      <div class="task-title">Eletrica Ritmo</div>
      <div class="task-sub">Tap when the needle hits the zone.</div>
      <div id="track" class="meter">
        <div id="target" class="target"></div>
        <div id="needle" class="needle"></div>
      </div>
      <div class="hud">
        <div>Hits: <span id="hits">0</span>/3</div>
        <div id="status" class="status">Stay on beat</div>
      </div>
      <button id="tap" class="task-button" type="button">Tap</button>
    </div>

    <script>
      const track = document.getElementById('track');
      const target = document.getElementById('target');
      const needle = document.getElementById('needle');
      const hitsEl = document.getElementById('hits');
      const statusEl = document.getElementById('status');
      const tapBtn = document.getElementById('tap');

      const totalHits = 3;
      let hits = 0;
      let pos = 0;
      let dir = 1;
      let active = true;
      let animId = null;

      function notifyComplete() {
        if (window.parent && window.parent !== window) {
          window.parent.postMessage({ type: 'TASK_COMPLETE', taskId: 'ELETRICA_RITMO' }, window.location.origin);
        }
      }

      function placeTarget() {
        const trackWidth = track.clientWidth;
        const targetWidth = 60;
        const maxX = Math.max(1, trackWidth - targetWidth);
        const start = Math.random() * maxX;
        target.style.left = `${start}px`;
      }

      function updateNeedle() {
        const trackWidth = track.clientWidth;
        const maxX = Math.max(1, trackWidth - 16);
        pos += dir * 2.8;
        if (pos <= 0) {
          pos = 0;
          dir = 1;
        }
        if (pos >= maxX) {
          pos = maxX;
          dir = -1;
        }
        needle.style.left = `${pos}px`;
        animId = requestAnimationFrame(updateNeedle);
      }

      function finish() {
        active = false;
        if (animId) cancelAnimationFrame(animId);
        statusEl.textContent = 'Calibration complete!';
        statusEl.classList.add('success');
        notifyComplete();
      }

      function registerHit() {
        if (!active) return;
        const needleBox = needle.getBoundingClientRect();
        const targetBox = target.getBoundingClientRect();
        const needleCenter = needleBox.left + needleBox.width / 2;
        if (needleCenter >= targetBox.left && needleCenter <= targetBox.right) {
          hits += 1;
          hitsEl.textContent = String(hits);
          statusEl.textContent = 'Nice!';
          placeTarget();
          if (hits >= totalHits) finish();
        } else {
          statusEl.textContent = 'Miss!';
        }
      }

      tapBtn.addEventListener('click', registerHit);
      placeTarget();
      updateNeedle();
    </script>
  </body>
</html>
